@model  ProjectLeague.ViewModels.Teamcontainer
@{
    ViewBag.Title = "Match";
}
<div id="logging">
    <div id="contentChat">
    </div>
    <div class="inputlogging">
        <input type="text" id="inputChat" onkeypress="send(event)">
    </div>
</div>

<div class="match">
    <div class="matchDetails">
        <div class="red-details">
            <img src="~/Content/img/dragon.png"><img src="~/Content/img/dragon.png">
        </div>
        <div class="blue-details">
            <img src="~/Content/img/dragon.png"><img src="~/Content/img/baron.png">
        </div>
        <div class="score">20/20</div>
    </div>
    @foreach (var team in Model.Teams)
    {
        <div class="@team.Teamname">
            @foreach (var player in team.Players)
                {
                <div class="participant" id="@player.Id">
                    <div>
                        <img id="championImg" src="@Url.Content(player.ChampionUrl)">
                    </div>
                    <div class="summonerName">
                        @player.Champion
                    </div>
                    <div class="itemList">
                        <div class="item">
                            <img src="~/Content/img/none.png" id="@player.Id-0">
                        </div>
                        <div class="item">
                            <img src="~/Content/img/none.png" id="@player.Id-1" >
                        </div> <div class="item">
                            <img src="~/Content/img/none.png" id="@player.Id-2">
                        </div> <div class="item" >
                            <img src="~/Content/img/none.png" id="@player.Id-3">
                        </div> <div class="item" >
                            <img src="~/Content/img/none.png" id="@player.Id-4">
                        </div>
                        <div class="item" id="6">
                            <img src="~/Content/img/none.png" id="@player.Id-5">
                        </div>
                        <div class="item" id="6">
                            <img src="~/Content/img/none.png" id="@player.Id-6">
                        </div>
                    </div>
                    <div class="kda">
                        0/0/0
                    </div>
                </div>
            }
        </div>
    }
</div>
<div id="content"></div>
<canvas id="canvas" height="400" width="400"></canvas>
<script>
    var IsConnected = false;
    var groupName =  @Html.Raw(Json.Encode(Model.GroupName));
    var username = @Html.Raw(Json.Encode(Model.UserName));
    var itemDisplayed = [[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]];
    var participants;
    var proxy;
    var chatProxy;
    function send(event){
        if(event.keyCode === 13){
            if(IsConnected)
            {
                var chatContent = $("#inputChat").val();
                $("#inputChat").val("");
                if(chatContent.indexOf("/nick")>-1){
                    var chat =  chatContent.substr(5,chatContent.length);
                    username = chat;
                }else if(chatContent.indexOf("/users")>-1)
                {
                    proxy.invoke("GetConnectedUsers",groupName);
                }else{
                    var content =  username+"> ";
                    content += chatContent;
                    console.log(content+"<---");
                    
                    proxy.invoke("SendMessage",content,groupName);
                }
            }
        }
        return false;
    }
    window.onload = function () {
        participants = $(".participant");
        console.log(participants);
        var connection = $.hubConnection();
        proxy = connection.createHubProxy('LeagueHub');
        chatProxy = connection.createHubProxy('ChatHub');
        proxy.on("Position", function (text) {
        });
        proxy.on("RetrieveMessage",function(content){
            $("#contentChat").append("<p class='chatLine'>"+content+"</p>");
        }
        );
        proxy.on("ItemPurchased",function(partId,itemId){
            var itemPart = itemDisplayed[partId];

            if(itemId===3340||itemId===3341||itemId===3361||itemId===3362||itemId===3363||itemId===3364||itemId===3340||itemId===3462){
                $("#"+partId+"-6").attr("src","/Content/img/items/"+itemId+".png");
                itemDisplayed[partId][6] = itemId;
            }else{
                for(var i=0;i<itemPart.length;i++)
                {
                    if(itemPart[i]==0)
                    {
                        $("#"+partId+"-"+i).attr("src","/Content/img/items/"+itemId+".png");
                        itemDisplayed[partId][i] = itemId;
                        break;
                    }
                }
                console.log(itemPart);
                //$("#contentChat").append("<p class='chatLine'>"+content+"</p>");
            }}
       );
        proxy.on("ItemDestroyed",function(partId,itemId){
            var itemPart = itemDisplayed[partId];
            console.log("ITEM PURCHESED " + partId);
            for(var i=0;i<itemPart.length;i++)
            {
                if(itemPart[i]==itemId)
                {
             
                    $("#"+partId+"-"+i).attr("src","/Content/img/none.png");
                    itemDisplayed[partId][i] = 0;
                    break;
                }
            }
            console.log(itemPart);
            //$("#contentChat").append("<p class='chatLine'>"+content+"</p>");
        }
       );
        connection.start().done(function () {
            IsConnected = true;
            proxy.invoke("Join",@Html.Raw(Json.Encode(Model.GroupName)),username);
            proxy.invoke("SendMatchData",@Html.Raw(Json.Encode(Model.MatchId)), @Html.Raw(Json.Encode(Model.GroupName)));
        });


    }
</script>